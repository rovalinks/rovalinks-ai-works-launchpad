name: Handle New Subscriber

permissions:
  contents: write

on:
  repository_dispatch:
    types: [new_subscriber]
  workflow_dispatch:
    inputs:
      email:
        description: 'Subscriber email'
        required: true
        type: string

jobs:
  add-subscriber:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set EMAIL variable
        run: |
          if [ -n "${{ github.event.client_payload.email }}" ]; then
            echo "EMAIL_VAL=${{ github.event.client_payload.email }}" >> $GITHUB_ENV
          else
            echo "EMAIL_VAL=${{ github.event.inputs.email }}" >> $GITHUB_ENV
          fi

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: pip install pandas requests

      - name: Send email via ZeptoMail (Pre-check)
        env:
          EMAIL: ${{ env.EMAIL_VAL }}
          ZEPTOMAIL_API_TOKEN: ${{ secrets.ZEPTOMAIL_API_TOKEN }}
        run: |
          python <<EOF
          import os, json, requests, re, sys
          from datetime import datetime, timezone
          import pandas as pd

          user_email = os.getenv("EMAIL")
          token = os.getenv("ZEPTOMAIL_API_TOKEN")
          from_email = "noreply@rovalinks.com"
          admin_email = "hr@rovalinks.com"

          def is_valid_email(email):
              return re.match(r"[^@]+@[^@]+\\.[^@]+", email)

          if not is_valid_email(user_email):
              print(f"Invalid email: {user_email}")
              sys.exit(1)

          headers = {
              "accept": "application/json",
              "content-type": "application/json",
              "authorization": f"Zoho-enczapikey {token}"
          }

          def notify_admin_failure(reason):
              html = f'''
              <html><body>
                <h2 style="color:red">‚ùå Subscription failed</h2>
                <p><strong>Email:</strong> {user_email}</p>
                <p><strong>Reason:</strong> {reason}</p>
              </body></html>
              '''

              payload = {
                  "from": {"address": from_email, "name": "Rovalinks AI"},
                  "to": [{"email_address": {"address": admin_email, "name": "Rovalinks HR"}}],
                  "subject": f"[Error] Failed to process subscriber: {user_email}",
                  "htmlbody": html
              }

              print("Notifying admin of failure...")
              try:
                  r = requests.post("https://api.zeptomail.in/v1.1/email", headers=headers, json=payload)
                  print("Admin notified:", r.status_code)
              except Exception as e:
                  print("Failed to notify admin:", e)
                  sys.exit(1)

          try:
              filepath = "subscribers/users.csv"
              os.makedirs("subscribers", exist_ok=True)
              df = pd.read_csv(filepath) if os.path.exists(filepath) else pd.DataFrame(columns=["email", "timestamp"])

              if user_email in df["email"].values:
                  raise Exception("User already exists.")

              df.loc[len(df)] = [user_email, datetime.now(timezone.utc).isoformat()]
              df.to_csv(filepath, index=False)

              # Send welcome email
              html = f'''
              <html><body>
                <div style="background: linear-gradient(135deg, #5A67D8, #805AD5); padding: 30px; color: white; text-align: center;">
                  <h1 style="margin: 0; font-size: 28px;">üéâ Welcome to Rovalinks AI Works!</h1>
                </div>
                <div style="padding: 30px; background: #ffffff;">
                  <p>Hi there,</p>
                  <p>Thanks for signing up for updates from <strong>Rovalinks AI Works</strong>!</p>
                  <p>We‚Äôre building the next generation of AI-powered products ‚Äî fast, innovative, and impactful.</p>
                  <p>You'll be the first to know about early access, launches, and exciting updates.</p>
                  <div style="margin-top: 20px; font-size: 14px; background: #f0f1f5; padding: 10px; border-left: 4px solid #805AD5;">
                    üì¨ Check your spam/promotions folder and mark us as "Not Spam".
                  </div>
                  <a href="https://rovalinks.com" style="display:inline-block; margin-top:20px; background:#5A67D8; color:#fff; padding:12px 24px; border-radius:6px; text-decoration:none; font-weight:bold;">Visit Our Website</a>
                  <p style="margin-top: 30px;">üöÄ Let's shape the future of AI ‚Äî together.</p>
                  <p>The Rovalinks Team</p>
                </div>
              </body></html>
              '''

              welcome_payload = {
                  "from": {"address": from_email, "name": "Rovalinks AI"},
                  "to": [{"email_address": {"address": user_email}}],
                  "subject": "üéâ Welcome to Rovalinks AI Works!",
                  "htmlbody": html
              }

              r = requests.post("https://api.zeptomail.in/v1.1/email", headers=headers, json=welcome_payload)
              r.raise_for_status()

              # Notify admin success
              admin_html = f'<html><body><p>‚úÖ New subscriber: <strong>{user_email}</strong></p></body></html>'
              admin_payload = {
                  "from": {"address": from_email, "name": "Rovalinks AI"},
                  "to": [{"email_address": {"address": admin_email, "name": "Rovalinks HR"}}],
                  "subject": f"New subscriber added: {user_email}",
                  "htmlbody": admin_html
              }
              r = requests.post("https://api.zeptomail.in/v1.1/email", headers=headers, json=admin_payload)
              print("‚úÖ Admin notified of success.")

          except Exception as e:
              notify_admin_failure(str(e))
              sys.exit(1)
          EOF
